<!--
Attention Visualizer, modified by Nathan Landman. 

Originally based on code by Andrej Karpathy described here:
  http://karpathy.github.io/2015/05/21/rnn-effectiveness/
and available here:
  http://cs.stanford.edu/people/karpathy/viscode.zip
Further Modified by Abigail See, here: https://github.com/abisee/attn_vis
-->

<!doctype html>
<html lang="en">
 <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Attention Visualizer</title>
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="external/d3.min.js"></script>
  <script src="external/jquery-3.1.0.min.js"></script>
  <script src="external/underscore-min.js"></script>
  <script src="external/sprintf.min.js"></script>
  <link href='http://fonts.googleapis.com/css?family=Cousine' rel='stylesheet' type='text/css'>

  <style>
  #curr_datafile{
    color: green;
    font-size: large;
    font-weight:bold;
    padding-top: 20px;
  }

  #buttons { 
      float: right;
  }
  .button {
    background-color: #4CAF50; /* Green */
    border: none;
    color: white;
    padding: 16px 32px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
    margin: 4px 2px;
    -webkit-transition-duration: 0.4s; /* Safari */
    transition-duration: 0.4s;
    cursor: pointer;
    border-radius: 8px;
  }
  .prevbutton{
      background-color: white;
      color: blue;
      border: 2px solid #008CBA;
  }
  .prevbutton:hover{
      background-color: #008CBA;
      color: white;
  }
  .nextbutton{
      background-color: white;
      color: green;
      border: 2px solid #4CAF50
  }
  .nextbutton:hover{
      background-color: #4CAF50;
      color:white;
  }
  #wrap {
    font-family: 'Cousine';
    position:relative;
    margin: 10px;
    font-size: 15px;
  }
  </style>
  <script>


  greenhue = 151
  yellowhue = 56

  function round(x, dp) {
    // round a float to dp decimal places
    var power_of_10 = 10**dp
    return Math.round(x*power_of_10)/power_of_10
  }

  function toColor(p, hue) {
    // converts a scalar value p in [0,1] to a HSL color code string with base color hue
    if (p<0 || p>1) {
      throw sprintf("Error: p has value %.2f but should be in [0,1]", p)
    }
    var saturation = 100 // saturation percentage
    p = 1-p // invert so p=0 is light and p=1 is dark
    var min_lightness = 50 // minimum percentage lightness, i.e. darkest possible color
    var lightness = (min_lightness + p*(100-min_lightness)) // lightness is proportional to p
    return sprintf('hsl(%d,%s%%,%s%%)', hue, saturation, lightness)
  }

  function render_art(div, data, dec_idx, dec_word) {
    // render the article. if dec_idx and dec_word are not null, we highlight the article with the attention distribution for decoder timestep dec_idx and corresponding decoder word dec_word
    var startix = 0;
    var endix = data.article_lst.length
    var attn_len = data.attn_dists[0].length
    var dec_len = data.attn_dists.length

    div.html(''); // flush
    for(var i=startix; i<endix; i++) {
      var word = data.article_lst[i]; // a string
      if (dec_idx == null) {
        var attn_wt = 0;
      } else {
        var attn_wt = data.attn_dists[dec_idx][i];
      }
      var background_color = toColor(attn_wt, yellowhue);
      var css = 'background-color:' + background_color;
      css += ';display:inline'
      var word_html = word + ' '

      // Insert "truncated here" marker to indicate how much of the original article we actually fed into the RNN
      // Note we only have attention distribution over the portion of the article before truncation
      if (i==attn_len) {
        dnew0 = div.append('div');
        dnew0.attr('class', 'd')
          .attr('style', 'color:green; font-weight:bold; text-decoration:underline; display:inline;') // apply this style
          .html('ARTICLE TRUNCATED HERE. ');
      }

      // write the sentence/word
      var dnew = div.append('div');
      dnew.attr('class', 'd')
        .attr('style', css) // apply this style
        .html(word_html)

      // highlight image 
      highlight_img(d3.select('#img'), gdata, i, attn_wt);

    }
  }


  function render_dec(div, data) {
    // render the decoded summary
    var startix = 0;
    var endix = data.decoded_lst.length;

    div.html(''); // flush
    for(var i=startix; i<endix; i++) {
      var word = data.decoded_lst[i]; // a string
      css = 'display:inline;'
      if (data.hasOwnProperty('p_gens')) {
        var p_gen = data.p_gens[i];
        var background_color = toColor(p_gen, greenhue);
        css += 'background-color:' + background_color;
      } else {
        var p_gen = null;
      }
      var dnew = div.append('div');

      dnew.html(word+' ') // this is the content
        .attr('class', 'd')
        .attr('style', css) // apply this style
        // add interactivity for mouseover decoder words
        .on('mouseover', getHandleMouseOver(i, word, p_gen))
        .on('mousemove', handleMouseMove)
        .on('mouseout', handleMouseOut)
    }
  }

  function getHandleMouseOver(dec_idx, dec_word, p_gen) {
     // When you mouseover a decoder word, shows attention distribution on article
     // p_gen is null for non-pointer models
    return function() {
      // Renders the article with the appropriate highlighting. Also renders the bounding boxes around the infographic.
      render_art(d3.select('#art'), gdata, dec_idx, dec_word);


      // Show a tooltip giving value of p_gen
      if (p_gen != null) {
        gtooltip.text(round(p_gen, 3))
        return gtooltip.style("visibility", "visible");
      }
    }
  }

  function handleMouseMove() {
    // When you move cursor over a decoder word, tooltip shows value of generation probability for that word
    return gtooltip.style("top", (d3.event.pageY-20)+"px").style("left",(d3.event.pageX+10)+"px");
  }

  function handleMouseOut() {
    // Remove all the highlights on the image
    var img_hlt = document.getElementsByClassName("img_hlt");
    while(img_hlt[0]) {
        img_hlt[0].parentNode.removeChild(img_hlt[0]);
    }

    // When you move cursor away from a decoder word, stop showing generation probability tooltip
    return gtooltip.style("visibility", "hidden");
  }

  function render_abs(div,data) {
    // Show the reference abstract (summary)
    div.html(''); // flush
    var dnew = div.append('div');
    dnew.html(data.abstract_str);
  }

  function render_img(div, data){
      div.html('');
      var img = document.createElement('img');
      img.src = 'images/fullsize-60k/'+data.url;
      img.style.position='relative';

      document.getElementById('img').appendChild(img);
      document.getElementById('img').style.position = 'relative';
  }

  function highlight_word(attn_wt, hue) {
    // converts a scalar value p in [0,1] to a HSL color code string with base color hue
    if (attn_wt<0 || attn_wt>1) {
      throw sprintf("Error: p has value %.2f but should be in [0,1]", p)
    }
    var saturation = 100 // saturation percentage. Less saturated would just mean gray. don't change.
    var lightness = 50 // minimum percentage lightness, i.e. darkest possible color
    //attn_wt = 1-attn_wt // invert so attn_wt=0 is transparent and attn_wt=1 is colored
    var alpha = (attn_wt) // lightness is proportional to p
    return sprintf('hsla(%d,%s%%,%s%%,%s)', hue, saturation, lightness, alpha)
  }

  function highlight_img(div, data, word_idx, attn_wt){
      var img_hlt= document.createElement('div');
      img_hlt.className = 'img_hlt';
      img_hlt.style.background = highlight_word(attn_wt, yellowhue);
      
      img_hlt.style.position = 'absolute';

      // t = top, r = right, l = left, b = bottom
      var [tl_x, tl_y, tr_x, tr_y, br_x, br_y, bl_x, bl_y] = data.positions.slice(8*word_idx, 8*(word_idx+1));

      img_hlt.style.width = (tr_x - tl_x)+'px';
      img_hlt.style.height = (br_y - tr_y)+'px';
      img_hlt.style.top= tr_y+'px';
      img_hlt.style.left= tl_x+'px';

      document.getElementById('img').appendChild(img_hlt);
  }

  function get_json_and_disp() {
    // Retrieve the json data file and display the data
    console.log("fetching " + json_fname + "...")

    function json_success(data) {
      // Displays the data
      console.log("success!")
      d3.select("#curr_datafile").html('Currently displaying: '+ data.url)
      gdata = data; // store globally
      render_art(d3.select("#art"), gdata, null, null);
      render_abs(d3.select("#abs"), gdata);
      render_dec(d3.select("#dec"), gdata);
      render_img(d3.select("#img"), gdata);
    }

    function json_fail(d) {
      // Tell the user it failed to load
      console.log("failure.")
      d3.select("#curr_datafile").html('<font color="red">Failed to load ' + json_fname + "</font>")
    }

    $.getJSON(json_fname, json_success).fail(json_fail);
  }

  filecounter = 0;
  function loadNext(){
      filecounter += 1;
      if (filecounter == num_files) {filecounter = 0}
      json_fname = 'just_glove/'+urls[filecounter]
      get_json_and_disp();
  }
  
  function loadPrev(){
      filecounter -= 1;
      if (filecounter < 0) {filecounter = num_files-1}
      console.log(num_files)
      json_fname = 'just_glove/'+urls[filecounter]
      get_json_and_disp();
  }

  function start() {
    //json_fname = "attn_vis_data.json" // file containing the text and the weights
    $.get('just_glove_urls.txt', function(data){
        urls = data.split('\n').slice(0,-1);
        num_files = urls.length;
        console.log(num_files)
        json_fname = 'just_glove/'+urls[filecounter]
        get_json_and_disp()
    });
    
    console.log("start");

    // Define a tooltip that we will use to display generation probability of a decoder word when you hover over it
    var tooltip = d3.select("body")
        .append("div")
        .style("position", "absolute")
        .style("z-index", "10")
        .style("visibility", "hidden")
        .style("background", "white")
        .style("font-size", "15px")
        .style("font-family", "Cousine")
        .text("a simple tooltip");
    gtooltip = tooltip // global
  }

  </script>
    </head>
    <body onload="start();">
      <div id="wrap">
         <div id='buttons'>
          <button class="button prevbutton" onclick='loadPrev()'>Previous</button>
          <button class="button nextbutton" onclick="loadNext()">Show me another!</button>
        </div>
        <div id="curr_datafile">
          Current datafile name goes here.  
        </div>

      <h2>Infographic Title</h2>
      <div id="abs">
        reference summary goes here
      </div>

      <h2>Extracted Text</h2>
      <div id="art">
        article goes here
      </div>
            <h2>Generated summary (highlighted = high generation probability)</h2>
      <div id="dec">
        generated summary goes here
      </div>
      <h2>Source</h2>
      <div id="img">
        generated image goes here
      </div>
    </div>
  </body>
</html>
